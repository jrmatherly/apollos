# Workflow: Add New Django Model
# Usage: npx claude-flow@v3alpha workflow run -f .claude-flow/workflows/django-new-model.yaml --task "Add Organization model"

name: django-new-model
description: Add a new Django model with adapter, migration, admin registration, and tests
topology: hierarchical
strategy: specialized

steps:
  - name: specify
    agent: planner
    description: |
      Define the model specification:
      1. Model name, fields, relationships, constraints
      2. Which existing models it relates to
      3. Required adapter methods (CRUD + any custom queries)
      4. Admin registration requirements
      Reference: src/apollos/database/models/__init__.py for existing patterns

  - name: implement-model
    agent: coder
    depends_on: [specify]
    description: |
      Add the model to src/apollos/database/models/__init__.py
      Follow existing patterns:
      - Use DbBaseModel as base class
      - Add TextChoices enums for constrained fields
      - Add clean()/save() methods for validation
      - Add __str__ method
      - Add pre_save signal receivers if needed
      Style: ruff (line-length 120, double quotes)

  - name: implement-adapter
    agent: coder
    depends_on: [implement-model]
    description: |
      Add adapter class to src/apollos/database/adapters/__init__.py
      Follow existing patterns:
      - Class name: {ModelName}Adapters
      - Static/class methods for all operations
      - Both sync and async variants (prefix async with 'a')
      - Use Django ORM QuerySets, not raw SQL

  - name: create-migration
    agent: coder
    depends_on: [implement-model]
    description: |
      Generate Django migration:
      $ python src/apollos/manage.py makemigrations database
      Verify migration file is created in src/apollos/database/migrations/
      Check for proper dependencies on previous migration

  - name: register-admin
    agent: coder
    depends_on: [implement-model]
    description: |
      Register the model in src/apollos/database/admin.py
      Follow existing admin registration patterns

  - name: write-tests
    agent: tester
    depends_on: [implement-adapter]
    description: |
      Write tests in tests/ directory:
      - Add factory to tests/helpers.py (follow UserFactory pattern)
      - Test model creation, validation, constraints
      - Test adapter methods
      Use pytest + factory-boy fixtures

  - name: review
    agent: reviewer
    depends_on: [implement-model, implement-adapter, write-tests]
    description: |
      Review all changes:
      - Model follows existing patterns
      - Adapter has both sync/async methods
      - Migration is correct
      - Tests cover happy path + edge cases
      - Code style: ruff check --fix src/apollos/

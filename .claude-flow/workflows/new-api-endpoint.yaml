# Workflow: Add New API Endpoint
# Usage: npx claude-flow@v3alpha workflow run -f .claude-flow/workflows/new-api-endpoint.yaml --task "Add team management endpoints"

name: new-api-endpoint
description: Add a new FastAPI router with endpoints, auth, and tests
topology: hierarchical
strategy: specialized

steps:
  - name: specify
    agent: planner
    description: |
      Define the API specification:
      1. Router prefix (e.g., /api/teams)
      2. Endpoints: method, path, request/response schemas
      3. Authentication requirements (which auth paths)
      4. Rate limiting needs
      5. Required adapter methods (check adapters/__init__.py)
      Reference: src/apollos/routers/ for existing patterns

  - name: implement-router
    agent: coder
    depends_on: [specify]
    description: |
      Create router in src/apollos/routers/api_{name}.py
      Follow existing patterns:
      - Use APIRouter() from FastAPI
      - Import auth from configure.py (AuthenticatedApollosUser)
      - Use @requires("authenticated") decorator
      - Add rate limiting where needed (see helpers.py)
      - Use Pydantic models for request/response validation
      Style: ruff (line-length 120, double quotes)
      
      CRITICAL: Check permission/role before any data mutation.
      Pattern: request.user.object gives you the ApollosUser instance.

  - name: mount-router
    agent: coder
    depends_on: [implement-router]
    description: |
      Mount the router in src/apollos/configure.py or src/apollos/main.py
      Follow the existing pattern for how other routers are mounted.
      IMPORTANT: Import order matters - Django must be initialized first.

  - name: implement-adapters
    agent: coder
    depends_on: [specify]
    description: |
      Add any needed adapter methods to src/apollos/database/adapters/__init__.py
      Both sync and async variants.

  - name: write-tests
    agent: tester
    depends_on: [implement-router, implement-adapters]
    description: |
      Write API tests:
      - Use the `client` fixture (authenticated) from conftest.py
      - Test each endpoint: happy path, auth required, invalid input
      - Test permission boundaries (user can't access other user's data)

  - name: security-review
    agent: security-auditor
    depends_on: [implement-router]
    description: |
      Review the new endpoints for:
      - Auth bypass vulnerabilities
      - Missing rate limiting
      - Input validation gaps
      - Data leakage across users
      - IDOR (Insecure Direct Object Reference)

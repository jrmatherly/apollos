services:
  database:
    image: docker.io/pgvector/pgvector:pg17
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: apollos
    volumes:
      - apollos_db:/var/lib/postgresql/data/
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 5
  sandbox:
    image: ghcr.io/jrmatherly/terrarium:latest
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 2
  search:
    image: docker.io/searxng/searxng:latest
    volumes:
      - apollos_search:/etc/searxng
    environment:
      - SEARXNG_BASE_URL=http://localhost:8080/
  # Creates Computer for Apollos to use.
  # Set APOLLOS_OPERATOR_ENABLED=True in the server service environment variable to enable.
  computer:
    container_name: apollos-computer
    # image: ghcr.io/jrmatherly/apollos-computer:latest
    build:
      context: .
      dockerfile: computer.Dockerfile
    ports:
      - "5900:5900"
    volumes:
      - apollos_computer:/home/operator
  server:
    depends_on:
      database:
        condition: service_healthy
    # Use the following line to use the latest version of apollos. Otherwise, it will build from source. Set this to ghcr.io/jrmatherly/apollos-cloud:latest if you want to use the prod image.
    # image: ghcr.io/jrmatherly/apollos:latest
    # Uncomment the following line to build from source. This will take a few minutes. Comment the next two lines out if you want to use the official image.
    build:
    context: .
    ports:
      # If changing the local port (left hand side), no other changes required.
      # If changing the remote port (right hand side),
      #   change the port in the args in the build section,
      #   as well as the port in the command section to match
      - "42110:42110"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    working_dir: /app
    volumes:
      - apollos_config:/root/.apollos/
      - apollos_models:/root/.cache/torch/sentence_transformers
      - apollos_models:/root/.cache/huggingface
      # uncomment line below to mount docker socket to allow apollos to use its computer.
      # - /var/run/docker.sock:/var/run/docker.sock
      # uncomment line below to mount a bootstrap config file for model setup.
      # - ./bootstrap.jsonc:/app/bootstrap.jsonc:ro
    # Use 0.0.0.0 to explicitly set the host ip for the service on the container. https://pythonspeed.com/articles/docker-connection-refused/
    environment:
      - POSTGRES_DB=apollos
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_HOST=database
      - POSTGRES_PORT=5432
      - APOLLOS_DJANGO_SECRET_KEY=secret
      - APOLLOS_DEBUG=False
      - APOLLOS_ADMIN_EMAIL=admin@apollosai.dev
      - APOLLOS_ADMIN_PASSWORD=password
      # Default URL of Terrarium, the default Python sandbox used by Apollos to run code. Its container is specified above
      - APOLLOS_TERRARIUM_URL=http://sandbox:8080
      # Uncomment line below to have Apollos run code in remote E2B code sandbox instead of the self-hosted Terrarium sandbox above. Get your E2B API key from https://e2b.dev/.
      # - E2B_API_KEY=your_e2b_api_key
      # Default URL of SearxNG, the default web search engine used by Apollos. Its container is specified above
      - APOLLOS_SEARXNG_URL=http://search:8080
      # Uncomment line below to use with Ollama running on your local machine at localhost:11434.
      # Change URL to use with other OpenAI API compatible providers like VLLM, LMStudio, DeepInfra, DeepSeek etc.
      # - OPENAI_BASE_URL=http://host.docker.internal:11434/v1/
      # - APOLLOS_DEFAULT_CHAT_MODEL=qwen3
      #
      # Uncomment appropriate lines below to use chat models by OpenAI, Anthropic, Google.
      # Ensure you set your provider specific API keys.
      # ---
      # - OPENAI_API_KEY=your_openai_api_key
      # - GEMINI_API_KEY=your_gemini_api_key
      # - ANTHROPIC_API_KEY=your_anthropic_api_key
      #
      # Embedding Model Configuration
      # Uncomment and configure to use a remote embedding model instead of the default local model (thenlper/gte-small).
      # - APOLLOS_EMBEDDING_MODEL=text-embedding-3-small
      # - APOLLOS_EMBEDDING_DIMENSIONS=1536
      # - APOLLOS_EMBEDDING_API_TYPE=openai
      # - APOLLOS_EMBEDDING_API_KEY=your_openai_api_key
      # - APOLLOS_EMBEDDING_ENDPOINT=https://api.openai.com/v1
      # - APOLLOS_CROSS_ENCODER_MODEL=mixedbread-ai/mxbai-rerank-xsmall-v1
      #
      # Chat Model List Configuration
      # Override which chat models are created on first bootstrap. Comma-separated.
      # Set to empty value to skip creating models for that provider.
      # - APOLLOS_OPENAI_CHAT_MODELS=gpt-4o-mini,gpt-4.1,o3,o4-mini
      # - APOLLOS_GEMINI_CHAT_MODELS=gemini-2.0-flash,gemini-2.5-flash,gemini-2.5-pro,gemini-2.5-flash-lite
      # - APOLLOS_ANTHROPIC_CHAT_MODELS=claude-sonnet-4-0,claude-3-5-haiku-latest
      #
      # Server Chat Slot Configuration
      # Assign specific models to ServerChatSettings slots. chat_default, think_free_fast,
      # and think_free_deep require FREE price tier models.
      # - APOLLOS_DEFAULT_CHAT_MODEL=gpt-4o-mini
      # - APOLLOS_ADVANCED_CHAT_MODEL=gpt-4.1
      # - APOLLOS_THINK_FREE_FAST_MODEL=gpt-4o-mini
      # - APOLLOS_THINK_FREE_DEEP_MODEL=o3
      # - APOLLOS_THINK_PAID_FAST_MODEL=gpt-4.1
      # - APOLLOS_THINK_PAID_DEEP_MODEL=o3
      #
      # Bootstrap Configuration File
      # Mount a JSONC config file and set this env var to configure all models from a single file.
      # Chat slot env vars (APOLLOS_*_CHAT_MODEL) override bootstrap slots.
      # Embedding and chat-list env vars only apply when no bootstrap config exists.
      # - APOLLOS_BOOTSTRAP_CONFIG=/app/bootstrap.jsonc
      #
      # Uncomment line below to enable Apollos to use its computer.
      # - APOLLOS_OPERATOR_ENABLED=True
      # Uncomment appropriate lines below to enable web results with Apollos
      # Ensure you set your provider specific API keys.
      # ---
      # Paid, Fast API. Only does web search. Get API key from https://serper.dev/
      # - SERPER_DEV_API_KEY=your_serper_dev_api_key
      # Paid, Higher Read Success API. Only does webpage read. Get API key from https://olostep.com/
      # - OLOSTEP_API_KEY=your_olostep_api_key
      # Paid, Open API. Does both web search and webpage read. Get API key from https://firecrawl.dev/
      # - FIRECRAWL_API_KEY=your_firecrawl_api_key
      # Paid, Fast API. Does both web search and webpage read. Get API key from https://exa.ai/
      # - EXA_API_KEY=your_exa_api_key
      #
      # Uncomment the necessary lines below to make your instance publicly accessible.
      # Proceed with caution, especially if you are using anonymous mode.
      # ---
      # - APOLLOS_NO_HTTPS=True
      # Replace the APOLLOS_DOMAIN with the server's externally accessible domain or I.P address from a remote machie (no http/https prefix).
      # Ensure this is set correctly to avoid CSRF trusted origin or unset cookie issue when trying to access the admin panel.
      # - APOLLOS_DOMAIN=192.168.0.104
      # - APOLLOS_DOMAIN=apollos.example.com
      # Replace the APOLLOS_ALLOWED_DOMAIN with the server's internally accessible domain or I.P address on the host machine (no http/https prefix).
      # Only set if using a load balancer/reverse_proxy in front of your Apollos server. If unset, it defaults to APOLLOS_DOMAIN.
      # For example, if the load balancer service is added to the apollos docker network, set APOLLOS_ALLOWED_DOMAIN to apollos's docker service name: `server'.
      # - APOLLOS_ALLOWED_DOMAIN=server
      # - APOLLOS_ALLOWED_DOMAIN=127.0.0.1
      # Uncomment the line below to disable telemetry.
      # Telemetry helps us prioritize feature development and understand how people are using Apollos
      # Read more at https://docs.apollosai.dev/miscellaneous/telemetry
      # - APOLLOS_TELEMETRY_DISABLE=True
    # Comment out this line when you're using the official ghcr.io/jrmatherly/apollos-cloud:latest prod image.
    command: --host="0.0.0.0" --port=42110 -vv --anonymous-mode --non-interactive

volumes:
  apollos_config:
  apollos_db:
  apollos_models:
  apollos_search:
  apollos_computer:
